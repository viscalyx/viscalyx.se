# Cross-Origin Warning Integration Tests

> Test flow documentation for [`cross-origin-warning.spec.ts`](cross-origin-warning.spec.ts)

This test suite verifies that the Next.js dev server does not emit cross-origin
warnings when the application is accessed via `0.0.0.0` or `127.0.0.1` (common
in devcontainer and Docker setups). It validates the fix for [GitHub issue #128](https://github.com/viscalyx/viscalyx.se/issues/128), which requires
`allowedDevOrigins: ['0.0.0.0', '127.0.0.1']` in `next.config.ts`.

---

## Background

When running Next.js inside a devcontainer, the dev server is often accessed via
`http://0.0.0.0:<port>`. Starting with Next.js 16, this triggers a server-side
warning:

> ⚠ Cross origin request detected from 0.0.0.0 to /\_next/\* resource.

The warning is only visible in the server's stdout/stderr — not in the browser
console — making it easy to miss. The fix is a single config line:

<!-- markdownlint-disable MD013 -->
```ts
allowedDevOrigins: ['0.0.0.0', '127.0.0.1']
```
<!-- markdownlint-enable MD013 -->

---

## Overview — Test Decision Flow

<!-- markdownlint-disable MD013 -->
```mermaid
flowchart TD
    A[Start] --> B{Static config check}
    B -- Pass --> C["next.config.ts contains<br/>allowedDevOrigins + 0.0.0.0 + 127.0.0.1"]
    B -- Fail --> D["❌ Config missing<br/>allowedDevOrigins or origin"]

    A --> E{Runtime browser check}
    E --> F["For each origin:<br/>0.0.0.0, 127.0.0.1"]
    F --> G["Navigate browser to<br/>http://origin:3000"]
    G --> H["Check /_next/* resources loaded"]
    H --> I{Any /_next/* requests failed?}
    I -- No --> J{Any cross-origin<br/>console errors?}
    J -- No --> K["✓ PASS"]
    J -- Yes --> L["❌ Console errors — FAIL"]
    I -- Yes --> M["❌ Resource failures — FAIL"]
```
<!-- markdownlint-enable MD013 -->

---

## Test Setup

### No shared `beforeEach`

This suite has **no shared setup hook**. Each test is self-contained:

- **Tests 1–2** (generated via `for` loop over `['0.0.0.0', '127.0.0.1']`)
  reuse the Playwright-managed dev server (port 3000) and verify resources load
  correctly from the browser side.
- **Test 3** reads the config file directly via `fs.readFileSync`.

### Design Decision: Reuse the Playwright-Managed Server

Earlier versions of these tests spawned dedicated `next dev` instances on
separate ports. This caused:

- `.next` build cache conflicts (two Next.js servers sharing the same project
  directory)
- Resource starvation in containers (multiple compilers running simultaneously)
- Flaky timeouts and port conflicts affecting other test files

The current approach reuses the Playwright-managed dev server on port 3000 and
validates from the **browser side** — checking that `/_next/*` resources load
successfully and no cross-origin errors appear in the console. The static config
test provides an additional fast guard.

### Constants

<!-- markdownlint-disable MD013 -->
| Name       | Value  | Description                                                                     |
| ---------- | ------ | ------------------------------------------------------------------------------- |
| `DEV_PORT` | `3000` | The Playwright-managed dev server port (from `playwright.config.ts` `baseURL`). |
<!-- markdownlint-enable MD013 -->

---

## Test Cases

<!-- markdownlint-disable MD013 -->
### 1–2. Should load page without cross-origin resource errors when accessing via {origin}
<!-- markdownlint-enable MD013 -->

These tests are generated by a `for...of` loop over `['0.0.0.0', '127.0.0.1']`,
producing one test per origin.

**Purpose:** Verify that navigating to the dev server via `http://{origin}:3000`
loads all `/_next/*` resources (JS, CSS) without network failures or
cross-origin console errors. If `allowedDevOrigins` were missing, the browser
would encounter blocked resources.

**Step-by-Step Flow:**

1. Create a new browser context.
2. Register listeners for failed network requests and console errors.
3. Navigate to `http://{origin}:3000` with `waitUntil: 'load'`.
4. Count `/_next/*` resources in the DOM (`<script>` and `<link>` elements).
5. Close the browser context.
6. Assert no `/_next/*` requests failed.
7. Assert at least one `/_next/*` resource was loaded.
8. Assert no cross-origin related console errors.

<!-- markdownlint-disable MD013 -->
```mermaid
sequenceDiagram
    participant T as Test Runner
    participant B as Browser
    participant S as Dev Server (port 3000)

    T->>B: Create new browser context
    T->>B: Register requestfailed listener
    T->>B: Register console error listener

    B->>S: GET http://{origin}:3000
    S-->>B: HTML response
    B->>S: GET /_next/*.js, /_next/*.css
    S-->>B: JS/CSS resources
    Note over S: Sub-resource requests have<br/>Origin: http://{origin}:3000

    T->>B: Evaluate DOM for /_next/* resources
    B-->>T: Resource count

    T->>B: Close browser context

    T->>T: Assert no /_next/* request failures
    T->>T: Assert resource count > 0
    T->>T: Assert no cross-origin console errors
    Note over T: ✓ All checks passed
```
<!-- markdownlint-enable MD013 -->

#### Resource validation flowchart

<!-- markdownlint-disable MD013 -->
```mermaid
flowchart LR
    A["Navigate to {origin}:3000"] --> B["Collect failed requests<br/>+ console errors"]
    B --> C{"Any /_next/*<br/>failures?"}
    C -- No --> D{"/_next/* resource<br/>count > 0?"}
    D -- Yes --> E{"Cross-origin<br/>console errors?"}
    E -- No --> F["✓ PASS"]
    E -- Yes --> G["❌ FAIL"]
    D -- No --> G
    C -- Yes --> G
```
<!-- markdownlint-enable MD013 -->

---

### 3. next.config.ts should have allowedDevOrigins configured

**Purpose:** Static validation that the `next.config.ts` file contains the
`allowedDevOrigins` key with both `0.0.0.0` and `127.0.0.1` entries. This acts
as a fast guard-rail — if someone removes a config entry, this test fails
instantly without needing to boot a dev server.

**Step-by-Step Flow:**

1. Read the contents of `next.config.ts` using
   `fs.readFileSync('next.config.ts', 'utf-8')`.
2. Assert the file content contains the string `"allowedDevOrigins"`.
3. Assert the file content matches the regex `/0\.0\.0\.0/`.
4. Assert the file content matches the regex `/127\.0\.0\.1/`.

<!-- markdownlint-disable MD013 -->
```mermaid
sequenceDiagram
    participant T as Test Runner
    participant FS as File System

    T->>FS: fs.readFileSync("next.config.ts", "utf-8")
    FS-->>T: File contents (string)

    T->>T: Check contents.includes("allowedDevOrigins")
    Note over T: ✓ "allowedDevOrigins" found

    T->>T: Check contents.match(/0\.0\.0\.0/)
    Note over T: ✓ "0.0.0.0" origin present

    T->>T: Check contents.match(/127\.0\.0\.1/)
    Note over T: ✓ "127.0.0.1" origin present
```
<!-- markdownlint-enable MD013 -->

#### Config validation flowchart

<!-- markdownlint-disable MD013 -->
```mermaid
flowchart LR
    A["Read next.config.ts"] --> B{"Contains<br/>allowedDevOrigins?"}
    B -- Yes --> C{"Contains<br/>0.0.0.0?"}
    C -- Yes --> F{"Contains<br/>127.0.0.1?"}
    F -- Yes --> D["✓ PASS"]
    F -- No --> E["❌ FAIL"]
    C -- No --> E
    B -- No --> E
```
<!-- markdownlint-enable MD013 -->
